# Stream Aggregator API 要件定義書

## 概要

Stream Aggregator APIは、YouTube・Twitch配信の統合管理を行うFastAPIベースのバックエンドサービスです。フロントエンドアプリケーションからの1分間隔のリクエストに応じて外部API（YouTube Data API v3, Twitch API）から最新の配信データを取得し、Supabaseデータベースに保存・管理します。Supabase Auth JWTによる認証機能を提供し、Railway環境での単一インスタンスデプロイをサポートします。

## ユーザストーリー

### ストーリー1: 配信視聴者としての配信一覧取得

- **である** 配信視聴者 **として**
- **私は** 複数プラットフォーム（YouTube・Twitch）の配信情報を一元的に **取得したい**
- **そうすることで** プラットフォーム間を行き来せずに効率的に視聴したい配信を見つけられる

### ストーリー2: 配信管理者としてのチャンネル登録

- **である** 配信管理者 **として**
- **私は** 監視したいチャンネルを登録・削除 **したい**
- **そうすることで** 特定のチャンネルの配信情報を継続的に追跡できる

### ストーリー3: システム利用者としての認証

- **である** システム利用者 **として**
- **私は** 安全にログイン・ログアウト **したい**
- **そうすることで** 個人の設定やデータを保護しながらサービスを利用できる

### ストーリー4: フロントエンド開発者としてのAPI利用

- **である** フロントエンド開発者 **として**
- **私は** 1分間隔でリアルタイム配信データを取得 **したい**
- **そうすることで** ユーザーに最新の配信状況を提供できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは認証されたユーザーに対して配信一覧を返却しなければならない
- REQ-002: システムはSupabase Auth JWTによる認証・認可を実装しなければならない
- REQ-003: システムはチャンネルの登録・削除機能を提供しなければならない
- REQ-004: システムは登録チャンネルの一覧表示機能を提供しなければならない
- REQ-005: システムはYouTube Data API v3から配信データを取得しなければならない
- REQ-006: システムはTwitch APIから配信データを取得しなければならない
- REQ-007: システムは取得した配信データをSupabaseデータベースに保存しなければならない
- REQ-008: システムはRESTful API設計に従ったエンドポイントを提供しなければならない
- REQ-009: システムはSwagger UIによるAPI仕様書を提供しなければならない

### 条件付き要件

- REQ-101: フロントエンドから `/api/streams/refresh` がコールされた場合、システムは外部APIから最新データを取得しなければならない
- REQ-102: JWTトークンが無効または期限切れの場合、システムは401 Unauthorizedを返却しなければならない
- REQ-103: 外部API呼び出しがレート制限に達した場合、システムは適切なエラーメッセージを返却しなければならない
- REQ-104: データベース接続エラーが発生した場合、システムは500 Internal Server Errorを返却しなければならない
- REQ-105: 存在しないチャンネルIDが指定された場合、システムは404 Not Foundを返却しなければならない

### 状態要件

- REQ-201: ユーザーがログイン状態にある場合、システムは認証が必要なエンドポイントへのアクセスを許可しなければならない
- REQ-202: チャンネルが非公開状態にある場合、システムは配信情報の取得をスキップしなければならない
- REQ-203: サービスがメンテナンス状態にある場合、システムは503 Service Unavailableを返却しなければならない

### オプション要件

- REQ-301: システムは配信タイトル・説明文による検索機能を提供してもよい
- REQ-302: システムは配信ジャンル・カテゴリによるフィルタリング機能を提供してもよい
- REQ-303: システムはお気に入りチャンネル機能を提供してもよい
- REQ-304: システムは配信開始・終了の通知機能を提供してもよい

### 制約要件

- REQ-401: システムはRailway環境での単一インスタンスデプロイに対応しなければならない
- REQ-402: システムはSupabase Python SDKを使用してデータベース操作を行わなければならない
- REQ-403: システムはフロントエンドからの1分間隔リクエストに対応しなければならない
- REQ-404: システムはWebSocketやリアルタイム通信を使用してはならない
- REQ-405: システムはYouTube Data API v3の利用規約を遵守しなければならない
- REQ-406: システムはTwitch APIの利用規約を遵守しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: `/api/streams/refresh` エンドポイントは30秒以内にレスポンスを返却すること
- NFR-002: `/api/streams` エンドポイントは3秒以内にレスポンスを返却すること
- NFR-003: システムは同時接続数100まで対応すること
- NFR-004: 外部API呼び出し時のタイムアウトは20秒以内に設定すること

### セキュリティ

- NFR-101: すべてのAPIエンドポイントはHTTPS通信を使用すること
- NFR-102: JWT秘密鍵は環境変数で管理し、コードに直接記述しないこと
- NFR-103: 外部APIキーは環境変数で管理し、ログに出力しないこと
- NFR-104: ユーザー入力値は適切にバリデーションを行うこと
- NFR-105: SQLインジェクション対策を実装すること

### ユーザビリティ

- NFR-201: APIエラー時は適切なHTTPステータスコードとエラーメッセージを返却すること
- NFR-202: レスポンス形式は統一されたJSON構造を使用すること
- NFR-203: API仕様書は `/docs` エンドポイントでアクセス可能にすること

### 運用性

- NFR-301: アプリケーションログは構造化ログ形式で出力すること
- NFR-302: ヘルスチェックエンドポイント `/health` を提供すること
- NFR-303: 環境変数による設定変更が可能なこと

## Edgeケース

### エラー処理

- EDGE-001: YouTube APIが利用制限に達した場合、キャッシュされたデータを返却し、ログに警告を出力する
- EDGE-002: Twitch APIが一時的に利用不可能な場合、該当プラットフォームをスキップして処理を継続する
- EDGE-003: Supabaseへの接続が失敗した場合、リトライ機構（最大3回）を実行する
- EDGE-004: 不正な形式のJWTトークンが送信された場合、400 Bad Requestを返却する
- EDGE-005: 大量のチャンネル登録によるタイムアウトが発生した場合、バッチ処理で分割実行する

### 境界値

- EDGE-101: チャンネル登録数が1000件を超える場合、制限メッセージを表示する
- EDGE-102: API呼び出し頻度が1分間に100回を超える場合、レート制限を適用する
- EDGE-103: 配信タイトルが1000文字を超える場合、切り詰めて保存する
- EDGE-104: 同時リクエスト数が50を超える場合、503エラーを返却する

### データ整合性

- EDGE-201: 重複チャンネル登録を防ぐためのユニーク制約チェック
- EDGE-202: 削除されたチャンネルの配信データクリーンアップ
- EDGE-203: 古い配信データ（30日以上）の自動削除機能

## 受け入れ基準

### 機能テスト

- [ ] ユーザー認証（ログイン・ログアウト）が正常に動作すること
- [ ] チャンネルのCRUD操作が正常に動作すること
- [ ] YouTube APIから配信データを取得できること
- [ ] Twitch APIから配信データを取得できること
- [ ] `/api/streams/refresh` で最新データが更新されること
- [ ] `/api/streams` で配信一覧が取得できること
- [ ] 無効なJWTでのアクセスが拒否されること
- [ ] Swagger UI（`/docs`）でAPI仕様が確認できること

### 非機能テスト

- [ ] レスポンス時間がパフォーマンス要件を満たすこと
- [ ] 外部API障害時の適切なエラーハンドリングが動作すること
- [ ] データベース接続エラー時の適切な処理が動作すること
- [ ] HTTPSでの安全な通信が確立されること
- [ ] ログが適切に出力されること
- [ ] ヘルスチェックエンドポイントが正常応答すること

### セキュリティテスト

- [ ] JWTトークン検証が適切に動作すること
- [ ] APIキーが環境変数から正しく読み込まれること
- [ ] 入力値のバリデーションが適切に動作すること
- [ ] SQLインジェクション攻撃が防げること

### 統合テスト

- [ ] FastAPI + Supabase連携が正常に動作すること
- [ ] 外部API（YouTube・Twitch）との連携が正常に動作すること
- [ ] Railway環境でのデプロイが正常に完了すること
- [ ] フロントエンドからの1分間隔リクエストに対応できること

---

**作成日**: 2025-08-07
**バージョン**: 1.0
**承認者**: Stream Aggregator開発チーム
